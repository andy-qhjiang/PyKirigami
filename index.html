<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PyKirigami Viewer</title>
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; background: #f0f0f0; }
    canvas { display: block; }
    #info {
      position: absolute; top: 10px; left: 10px; padding: 8px 12px;
      background: rgba(0,0,0,0.7); color: #fff; font-family: monospace;
      border-radius: 5px; font-size: 14px; pointer-events: none;
    }
  </style>
</head>
<body>
<div id="info">Loading...</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js';
import { MTLLoader } from 'https://unpkg.com/three@0.158.0/examples/jsm/loaders/MTLLoader.js';
import { OBJLoader } from 'https://unpkg.com/three@0.158.0/examples/jsm/loaders/OBJLoader.js';

// --- CONFIGURATION ---
// This assumes your files are at: /output/scene.obj and /output/scene.mtl
const ASSET_PATH = './output/';
const SCENE_NAME = 'scene_1756683360'; // The base name of your files, without extension

// --- SETUP ---
const infoElement = document.getElementById('info');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f0f0);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(1, 1, 1);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// --- LIGHTING ---
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5, 5, 5);
scene.add(dirLight);

// --- LOAD MODEL ---
const mtlLoader = new MTLLoader();
mtlLoader.setPath(ASSET_PATH);

mtlLoader.load(`${SCENE_NAME}.mtl`,
  // Success callback
  (materials) => {
    materials.preload();
    const objLoader = new OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.setPath(ASSET_PATH);

    objLoader.load(`${SCENE_NAME}.obj`,
      // Success callback
      (object) => {
        infoElement.textContent = 'Model loaded!';

        // IMPORTANT: Convert from PyBullet's Z-up to three.js's Y-up
        object.rotation.x = -Math.PI / 2;

        // Auto-center and scale the model
        const box = new THREE.Box3().setFromObject(object);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 1.0 / maxDim;

        object.scale.multiplyScalar(scale);
        object.position.sub(center.multiplyScalar(scale));

        scene.add(object);
        console.log("Successfully loaded and added model to the scene.");
      },
      // Progress callback
      (xhr) => {
        if (xhr.lengthComputable) {
          const percentComplete = (xhr.loaded / xhr.total) * 100;
          infoElement.textContent = `Loading OBJ: ${Math.round(percentComplete)}%`;
        }
      },
      // Error callback
      (error) => {
        console.error('An error happened while loading the OBJ file:', error);
        infoElement.textContent = 'Error: Could not load OBJ file. Check console.';
      }
    );
  },
  // Progress callback
  (xhr) => {
    if (xhr.lengthComputable) {
      const percentComplete = (xhr.loaded / xhr.total) * 100;
      infoElement.textContent = `Loading MTL: ${Math.round(percentComplete)}%`;
    }
  },
  // Error callback
  (error) => {
    console.error('An error happened while loading the MTL file:', error);
    infoElement.textContent = 'Error: Could not load MTL file. Check console.';
  }
);

// --- RENDER LOOP ---
function animate() {
  requestAnimationFrame(animate);
  controls.update(); // only required if controls.enableDamping = true;
  renderer.render(scene, camera);
}
animate();

// --- RESIZE HANDLER ---
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

</script>
</body>
</html>
